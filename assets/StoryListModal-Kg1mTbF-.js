import{bu as E,bv as D,bw as B,bx as $,r as u,b as R,j as e,aK as w,m as M,N as O,by as A,bz as _,bA as H,bB as X,_ as S,aE as z,aM as T,l as F,a8 as U,a9 as V}from"./index-Bkyzi3h6.js";import{g as q,r as I,u as W}from"./index.esm2017-CfrAC03N.js";import{b as G}from"./index-CaXgJF1b.js";import{c as K}from"./index-CTFVIJ0c.js";import{a as Q}from"./useGetStories-CEklmVwi.js";function J(t){t.values.forEach(n=>n.stop())}function Y(){const t=new Set,n={subscribe(s){return t.add(s),()=>void t.delete(s)},start(s,o){const a=[];return t.forEach(l=>{a.push(E(l,s,{transitionOverride:o}))}),Promise.all(a)},set(s){return t.forEach(o=>{D(o,s)})},stop(){t.forEach(s=>{J(s)})},mount(){return()=>{n.stop()}}};return n}function Z(){const t=B(Y);return $(t.mount,[]),t}const L=Z;function ee(t,n){const[s,o]=u.useState(t),[a,l]=u.useState(!0),r=u.useRef(),x=u.useRef();return u.useEffect(()=>{if(!a)return x.current=Date.now(),r.current=setTimeout(()=>{n()},s),()=>clearTimeout(r.current)},[s,a,n]),{remainingTime:s,pause:a,handlePause:c=>{l(h=>c||!h)},setRemainingTime:o,setPause:l}}function te({setRemainingTime:t,loading:n,changeStoryHandler:s,pause:o,handlePause:a,contextMenuShow:l}){var f;const{story:r,slideindex:x,currentSlideIndex:g}=y(),c=u.useRef(),[h,d]=u.useState(!1),{auth_status:p,userId:v}=R(i=>i.userData);function N(){var C;d(!0),a();const i=q(),m=I(i,`stories/${r.id}`),b=p===401?getGuestUserId():v,j=(C=r==null?void 0:r.seenBy)==null?void 0:C.filter(k=>k!==b);W(m,{seenBy:[...j||[],b]})}return u.useEffect(()=>{c.current&&(o?c.current.pause():c.current.play())},[o]),e.jsxs("div",{className:"size-full relative z-40 overflow-hidden flex items-center justify-center p-6",children:[!h&&e.jsx(w,{className:"size-20 lg:size-36 absolute"}),(f=r.type)!=null&&f.startsWith("image/")?e.jsx("img",{src:r.contentUrl,alt:"story-content",className:"size-full object-contain",onLoad:()=>N()}):e.jsx("video",{ref:c,onLoadedData:()=>N(),onPlaying:i=>{const m=Math.max(0,(i.target.duration-i.target.currentTime)*1e3);t(m)},autoPlay:g===x,className:"size-full object-cover",src:r.contentUrl}),n&&e.jsxs("div",{className:"absolute z-50 inset-0 flex flex-col text-gray-200 gap-y-4 font-medium bg-gray-900/80 rounded-xl items-center justify-center",children:[e.jsx(w,{className:"size-24"}),e.jsx("p",{children:"Deleting story, please dont refresh page"})]}),e.jsxs("div",{onTouchStart:()=>a(!0),onTouchEnd:()=>a(!1),className:"absolute z-40 inset-0 flex lg:hidden",children:[e.jsx("div",{onClick:()=>!l&&!n&&s("prev"),className:"h-full w-2/5"}),e.jsx("div",{onClick:()=>!l&&!n&&s("next"),className:"h-full w-3/5"})]})]})}function se({remainingTime:t,pause:n}){const s=L(),{list:o,currentSlideIndex:a}=y();return u.useEffect(()=>{n?s.stop():s.start({translateX:"0%",transition:{duration:t/1e3,ease:"linear"}})},[n,t]),e.jsx("div",{className:"flex gap-2 p-2",children:o.map((l,r)=>e.jsx("p",{className:`${r===a?"bg-gray-50":"bg-gray-400"} w-full h-1 rounded-xl overflow-hidden relative`,children:r===a&&e.jsx(M.div,{className:"bg-primary-300 h-1 absolute left-0 top-0 w-full",initial:{translateX:"-100%"},animate:s,transition:{duration:t/1e3,ease:"linear"}})},r))})}function ne({pause:t,handlePause:n,onDeleteSlide:s,loading:o,contextMenuShow:a,setContextMenu:l}){const{changeStoryHandler:r,story:x}=y(),g=u.useRef();O(g,h,!a);const{userId:c}=R(v=>v.userData);function h(){n(),l(!1)}async function d(){try{n(!0),await s(x,()=>r("close")),S.success("story removed successfully"),n(!1)}catch(v){S.remove(),S.error("There was an error on delete story, please try again later"),n(!1),console.log(v)}}async function p(){}return e.jsxs("div",{ref:g,className:"flex items-center gap-x-2 relative",children:[e.jsx("button",{onClick:()=>n(),className:"text-gray-50",children:t?e.jsx(A,{className:"text-xl"}):e.jsx(G,{className:"text-2xl"})}),e.jsx("button",{onClick:()=>{n(!0),l(!0)},className:"text-3xl text-gray-50",children:e.jsx(_,{className:"rotate-90"})}),e.jsxs("div",{className:`${a?"opacity-100 visible":"opacity-0 invisible"} ${o&&"hidden"} text-base flex top-8 p-1 flex-col bg-gray-50 text-gray-950 absolute right-0 rounded-lg overflow-hidden`,children:[e.jsxs("button",{onClick:()=>{p(),l(!1)},disabled:!(x!=null&&x.highlightRef)||x.authorId!==c,className:"flex disabled:hidden hover:bg-gray-800 rounded-md hover:text-gray-50 transition-all items-center gap-x-2 text-center text-nowrap px-4 py-2",children:[e.jsx(K,{className:"text-xl"}),e.jsx("p",{children:"Remove highlight"})]}),e.jsxs("button",{disabled:x.authorId!==c,onClick:()=>{d(),l(!1)},className:"flex disabled:hidden hover:bg-gray-800 rounded-md hover:text-gray-50 transition-all items-center gap-x-2 text-center text-nowrap px-4 py-2",children:[e.jsx("p",{children:e.jsx(H,{})}),e.jsx("p",{children:"Delete story"})]}),e.jsxs("button",{onClick:()=>{r("close")},className:"flex disabled:hidden hover:bg-gray-800 rounded-md hover:text-gray-50 transition-all text-red-500 items-center gap-x-2 text-center text-nowrap px-4 py-2",children:[e.jsx(X,{className:"rotate-45 text-xl"}),e.jsx("p",{children:"Close"})]})]})]})}function ae(){const{changeStoryHandler:t,listIndex:n,currentListIndex:s,story:o}=y(),{remainingTime:a,pause:l,handlePause:r,setRemainingTime:x}=ee(5e3,()=>t("next")),[g,c]=u.useState(!1),{onDeleteSlide:h,loading:d,onRemoveHighlight:p}=Q(r);return e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"size-full relative z-50 bg-gray-950 lg:rounded-xl flex items-center",children:[e.jsx("div",{className:"z-50 absolute -left-4 h-1/2 hidden xl:flex items-center",children:e.jsx("button",{disabled:d,onClick:()=>t("prev"),className:"text-2xl disabled:hidden rounded-full p-1.5 hover:bg-opacity-100 bg-gray-50 bg-opacity-50 transition-all top-1/2 rotate-180",children:e.jsx(z,{})})}),e.jsxs("div",{className:`${n===s?"block":"hidden"} absolute z-50 top-0 w-full p-1`,children:[e.jsx(se,{pause:l,remainingTime:a}),e.jsxs("div",{className:"w-full flex items-center justify-between px-2",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"size-10 bg-gray-50/20 rounded-full overflow-hidden flex items-center justify-center",children:o!=null&&o.authorProfilePic?e.jsx("img",{src:o==null?void 0:o.authorProfilePic,className:"object-cover"}):e.jsx(T,{className:"text-4xl mt-2 text-gray-50"})}),e.jsx("h6",{className:"text-gray-50 text-lg",children:o.author.first_name})]}),e.jsx(ne,{pause:l,onRemoveHighlight:p,handlePause:r,onDeleteSlide:h,loading:d,contextMenuShow:g,setContextMenu:c})]})]}),e.jsx(te,{setRemainingTime:x,loading:d,changeStoryHandler:t,handlePause:r,pause:l,contextMenuShow:g}),e.jsx("div",{className:`${n!==s&&"!hidden"} absolute -right-4 h-1/2 hidden xl:flex items-center`,children:e.jsx("button",{disabled:d,onClick:()=>t("next"),className:"text-2xl disabled:hidden disabled:bg-gray-500 disabled:opacity-50 rounded-full p-1.5 z-40 hover:bg-opacity-100 bg-gray-50 bg-opacity-50 transition-all top-1/2",children:e.jsx(z,{})})})]}),d&&e.jsx("div",{className:"fixed inset-0 z-40"})]})}const le=(t,n,s)=>{const[o,a]=u.useState(0),l=u.useRef(),r=F({maxWidth:768}),[x,g]=u.useState(null),[c,h]=u.useState(!1);U(780,!1);const d=V();return u.useEffect(()=>{var i,m;const f=(m=(i=s[t])==null?void 0:i.slides)==null?void 0:m.findIndex(({isSeen:b})=>!b);a(f>=0?f:0)},[t]),u.useEffect(()=>{const f=document.querySelector(".currentSlide"),i=new IntersectionObserver(([m])=>{if(!m.isIntersecting&&x!==null){const b=x==="next"?t<s.length-1?t+1:null:t-1;h(!0),n(b),a(0),g(null)}},{threshold:.05});return f&&i.observe(f),()=>i.disconnect()},[x,t]),u.useEffect(()=>{if(c){const f=setTimeout(()=>h(!1),500);return()=>clearTimeout(f)}},[c]),u.useEffect(()=>{(()=>{if(!l.current)return;const i=document.querySelector(".currentSlide");if(!i)return;const m=i.getBoundingClientRect(),b=l.current.getBoundingClientRect(),j=m.left+m.width/2-(b.left+b.width/2);l.current.scrollLeft+=j})()},[t,r,c]),{containerRef:l,isChangingSlide:c,changeStory:f=>{const i=s[t],m=f==="next";if(f==="close"){n(null),a(0);return}else{let b=o+(m?1:-1);const j=t+(m?1:-1);(b<0||b>=i.slides.length)&&(n(j>=0&&j<s.length?j:null),b=0),a(b)}},handleTouch:(f,i)=>{if(i==="start")g(null),l.current.dataset.touchStart=f.touches[0].clientX;else if(i==="move"){const m=f.touches[0].clientX-l.current.dataset.touchStart;g(m>20?"prev":"next")}},getPaginatedLists:()=>d!=null&&d.id?s:s.map((f,i)=>({...f,listIndex:i})).filter((f,i)=>i===t-1||i===t||i===t+1),currentSlideIndex:o}},P=u.createContext();function ue({currentListIndex:t,setList:n,storiesList:s}){const{containerRef:o,isChangingSlide:a,changeStory:l,handleTouch:r,getPaginatedLists:x,currentSlideIndex:g}=le(t,n,s);return e.jsx("div",{ref:o,className:`${a?"overflow-hidden":"overflow-auto"} fixed bg-gray-950/80 hidden-scroll-bar inset-0 z-50 lg:flex items-center justify-center snap-x snap-mandatory lg:snap-none`,children:e.jsxs("div",{onTouchMove:c=>r(c,"move"),onTouchStart:c=>r(c,"start"),className:"inline-flex items-center lg:gap-x-8 size-full lg:px-[500vw]",children:[x().map(({slides:c,listIndex:h})=>{if(c)return e.jsx("div",{className:`${h===t?"lg:h-[95vh] currentSlide":"lg:h-[80vh]"} flex-none h-full select-none w-full lg:relative lg:w-96 transition-all duration-500 z-40 snap-end`,children:c.map((d,p)=>{var v;return t===h?g===p&&e.jsx(P.Provider,{value:{changeStoryHandler:l,listIndex:h,currentListIndex:t,list:c,currentSlideIndex:g,slideindex:p,story:d},children:e.jsx(ae,{},p)}):e.jsx("div",{className:"size-full first-of-type:flex hidden relative bg-gray-950 lg:rounded-xl items-center",children:e.jsxs("div",{onClick:()=>n(h),className:"size-full select-none flex flex-col gap-y-2 items-center justify-center",children:[e.jsx("div",{className:"size-28 bg-gray-50/20 overflow-hidden rounded-full",children:d!=null&&d.authorProfilePic?e.jsx("img",{src:d==null?void 0:d.authorProfilePic,className:"object-cover"}):e.jsx(T,{className:"text-4xl mt-2 text-gray-50"})}),e.jsx("h4",{className:"text-gray-50",children:(v=d.author)==null?void 0:v.first_name})]})},p)})},h)}),e.jsx("div",{className:`${a?"opacity-100 visible":"invisible opacity-0"} fixed inset-0 z-50 transition-all`}),e.jsx("div",{onClick:()=>n(null),id:"list-background",className:"fixed inset-0 bg-gray-950/80 hidden lg:block"})]})})}const y=()=>u.useContext(P);export{ue as S};
