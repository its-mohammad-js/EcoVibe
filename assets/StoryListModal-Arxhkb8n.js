import{bw as B,bx as O,by as A,bz as H,r as d,u as w,j as e,aH as k,bA as M,q as _,I as F,bB as U,bC as X,bD as q,bE as I,_ as C,aE as z,aJ as R,bF as V,p as W,aa as G,ab as J}from"./index-CI59rSFI.js";import{g as T,r as E,u as P}from"./index.esm2017-CFaB4tgL.js";import{a as Q}from"./index-BI6_L0PE.js";import{b as K}from"./index-Dtxq2BLV.js";import{a as Y}from"./useGetStories-B34THUy3.js";function Z(t){t.values.forEach(l=>l.stop())}function L(){const t=new Set,l={subscribe(n){return t.add(n),()=>void t.delete(n)},start(n,s){const a=[];return t.forEach(i=>{a.push(B(i,n,{transitionOverride:s}))}),Promise.all(a)},set(n){return t.forEach(s=>{O(s,n)})},stop(){t.forEach(n=>{Z(n)})},mount(){return()=>{l.stop()}}};return l}function ee(){const t=A(L);return H(t.mount,[]),t}const te=ee;function se(t,l){const[n,s]=d.useState(t),[a,i]=d.useState(!0),r=d.useRef(),m=d.useRef();return d.useEffect(()=>{if(!a)return m.current=Date.now(),r.current=setTimeout(()=>{l()},n),()=>clearTimeout(r.current)},[n,a,l]),{remainingTime:n,pause:a,handlePause:c=>{i(g=>c||!g)},setRemainingTime:s,setPause:i}}function ne({setRemainingTime:t,loading:l,changeStoryHandler:n,pause:s,handlePause:a,contextMenuShow:i}){var f;const{story:r,slideindex:m,currentSlideIndex:b}=S(),c=d.useRef(),[g,u]=d.useState(!1),{auth_status:v,userId:p}=w(o=>o.userData);function y(){var N;u(!0),a();const o=T(),h=E(o,`stories/${r.id}`),x=v===401?M():p,j=(N=r==null?void 0:r.seenBy)==null?void 0:N.filter($=>$!==x);P(h,{seenBy:[...j||[],x]})}return d.useEffect(()=>{c.current&&(s?c.current.pause():c.current.play())},[s]),e.jsxs("div",{className:"size-full relative z-40 overflow-hidden flex items-center justify-center p-6",children:[!g&&e.jsx(k,{className:"size-20 lg:size-36 absolute"}),(f=r.type)!=null&&f.startsWith("image/")?e.jsx("img",{src:r.contentUrl,alt:"story-content",className:"size-full object-contain",onLoad:()=>y()}):e.jsx("video",{ref:c,onLoadedData:()=>y(),onPlaying:o=>{const h=Math.max(0,(o.target.duration-o.target.currentTime)*1e3);t(h)},autoPlay:b===m,className:"size-full object-cover",src:r.contentUrl}),l&&e.jsxs("div",{className:"absolute z-50 inset-0 flex flex-col text-gray-200 gap-y-4 font-medium bg-gray-900/80 rounded-xl items-center justify-center",children:[e.jsx(k,{className:"size-24"}),e.jsx("p",{children:"Deleting story, please dont refresh page"})]}),e.jsxs("div",{onTouchStart:()=>a(!0),onTouchEnd:()=>a(!1),className:"absolute z-40 inset-0 flex lg:hidden",children:[e.jsx("div",{onClick:()=>!i&&!l&&n("prev"),className:"h-full w-2/5"}),e.jsx("div",{onClick:()=>!i&&!l&&n("next"),className:"h-full w-3/5"})]})]})}function le({remainingTime:t,pause:l}){const n=te(),{list:s,currentSlideIndex:a}=S();return d.useEffect(()=>{l?n.stop():n.start({translateX:"0%",transition:{duration:t/1e3,ease:"linear"}})},[l,t]),e.jsx("div",{className:"flex gap-2 p-2",children:s.map((i,r)=>e.jsx("p",{className:`${r===a?"bg-gray-50":"bg-gray-400"} w-full h-1 rounded-xl overflow-hidden relative`,children:r===a&&e.jsx(_.div,{className:"bg-primary-300 h-1 absolute left-0 top-0 w-full",initial:{translateX:"-100%"},animate:n,transition:{duration:t/1e3,ease:"linear"}})},r))})}function ae({pause:t,handlePause:l,onDeleteSlide:n,loading:s,contextMenuShow:a,setContextMenu:i}){const{changeStoryHandler:r,story:m}=S(),b=d.useRef();F(b,g,!a);const{userId:c}=w(p=>p.userData);function g(){l(),i(!1)}async function u(){try{l(!0),await n(m,()=>r("close")),C.success("story removed successfully"),l(!1)}catch(p){C.remove(),C.error("There was an error on delete story, please try again later"),l(!1),console.log(p)}}async function v(){}return e.jsxs("div",{ref:b,className:"flex items-center gap-x-2 relative",children:[e.jsx("button",{onClick:()=>l(),className:"text-gray-50",children:t?e.jsx(U,{className:"text-xl"}):e.jsx(Q,{className:"text-2xl"})}),e.jsx("button",{onClick:()=>{l(!0),i(!0)},className:"text-3xl text-gray-50",children:e.jsx(X,{className:"rotate-90"})}),e.jsxs("div",{className:`${a?"opacity-100 visible":"opacity-0 invisible"} ${s&&"hidden"} text-base flex top-8 p-1 flex-col bg-gray-50 text-gray-950 absolute right-0 rounded-lg overflow-hidden`,children:[e.jsxs("button",{onClick:()=>{v(),i(!1)},disabled:!(m!=null&&m.highlightRef)||m.authorId!==c,className:"flex disabled:hidden hover:bg-gray-800 rounded-md hover:text-gray-50 transition-all items-center gap-x-2 text-center text-nowrap px-4 py-2",children:[e.jsx(K,{className:"text-xl"}),e.jsx("p",{children:"Remove highlight"})]}),e.jsxs("button",{disabled:m.authorId!==c,onClick:()=>{u(),i(!1)},className:"flex disabled:hidden hover:bg-gray-800 rounded-md hover:text-gray-50 transition-all items-center gap-x-2 text-center text-nowrap px-4 py-2",children:[e.jsx("p",{children:e.jsx(q,{})}),e.jsx("p",{children:"Delete story"})]}),e.jsxs("button",{onClick:()=>{r("close")},className:"flex disabled:hidden hover:bg-gray-800 rounded-md hover:text-gray-50 transition-all text-red-500 items-center gap-x-2 text-center text-nowrap px-4 py-2",children:[e.jsx(I,{className:"rotate-45 text-xl"}),e.jsx("p",{children:"Close"})]})]})]})}function ie(){var h;const{changeStoryHandler:t,listIndex:l,currentListIndex:n,story:s}=S(),{remainingTime:a,pause:i,handlePause:r,setRemainingTime:m}=se(5e3,()=>t("next")),[b,c]=d.useState(!1),{onDeleteSlide:g,loading:u,onRemoveHighlight:v}=Y(r),{userId:p}=w(x=>x.userData),[y,f]=d.useState(!1);d.useEffect(()=>{var j;const x=(j=s==null?void 0:s.likes)==null?void 0:j.includes(p);f(x)},[s]);function o(){y?[...(s==null?void 0:s.likes)||[]].filter(N=>N!==p):[...(s==null?void 0:s.likes)||[]];const x=T(),j=E(x,`stories/${s.id}`);P(j,{likes:[...(s==null?void 0:s.likes)||[],p]})}return e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"size-full relative z-50 bg-gray-950 lg:rounded-xl flex items-center",children:[e.jsx("div",{className:"z-50 absolute -left-4 h-1/2 hidden xl:flex items-center",children:e.jsx("button",{disabled:u,onClick:()=>t("prev"),className:"text-2xl disabled:hidden rounded-full p-1.5 hover:bg-opacity-100 bg-gray-50 bg-opacity-50 transition-all top-1/2 rotate-180",children:e.jsx(z,{})})}),e.jsxs("div",{className:`${l===n?"block":"hidden"} absolute z-50 top-0 w-full p-1`,children:[e.jsx(le,{pause:i,remainingTime:a}),e.jsxs("div",{className:"w-full flex items-center justify-between px-2",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"size-10 bg-gray-50/20 rounded-full overflow-hidden flex items-center justify-center",children:s!=null&&s.authorProfilePic?e.jsx("img",{src:s==null?void 0:s.authorProfilePic,className:"object-cover"}):e.jsx(R,{className:"text-4xl mt-2 text-gray-50"})}),e.jsx("h6",{className:"text-gray-50 text-lg",children:s.author.first_name})]}),e.jsx(ae,{pause:i,onRemoveHighlight:v,handlePause:r,onDeleteSlide:g,loading:u,contextMenuShow:b,setContextMenu:c})]})]}),e.jsx(ne,{setRemainingTime:m,loading:u,changeStoryHandler:t,handlePause:r,pause:i,contextMenuShow:b}),e.jsxs("div",{className:"absolute w-full bottom-0 left-0 h-5 flex items-center pb-8 gap-x-2 z-50",children:[e.jsx("input",{type:"text",className:"bg-transparent outline-none border flex-1 px-2 py-2 border-gray-400 rounded-2xl",placeholder:"comment something"}),e.jsxs("button",{onClick:o,className:"text-gray-400 text-4xl",children:[e.jsx(V,{}),e.jsx("p",{className:"text-lg",children:(h=s==null?void 0:s.likes)==null?void 0:h.length})]})]}),e.jsx("div",{className:`${l!==n&&"!hidden"} absolute -right-4 h-1/2 hidden xl:flex items-center`,children:e.jsx("button",{disabled:u,onClick:()=>t("next"),className:"text-2xl disabled:hidden disabled:bg-gray-500 disabled:opacity-50 rounded-full p-1.5 z-50 hover:bg-opacity-100 bg-gray-50 bg-opacity-50 transition-all top-1/2",children:e.jsx(z,{})})})]}),u&&e.jsx("div",{className:"fixed inset-0 z-40"})]})}const re=(t,l,n)=>{const[s,a]=d.useState(0),i=d.useRef(),r=W({maxWidth:768}),[m,b]=d.useState(null),[c,g]=d.useState(!1);G(780,!1);const u=J();return d.useEffect(()=>{var o,h;const f=(h=(o=n[t])==null?void 0:o.slides)==null?void 0:h.findIndex(({isSeen:x})=>!x);a(f>=0?f:0)},[t]),d.useEffect(()=>{const f=document.querySelector(".currentSlide"),o=new IntersectionObserver(([h])=>{if(!h.isIntersecting&&m!==null){const x=m==="next"?t<n.length-1?t+1:null:t-1;g(!0),l(x),a(0),b(null)}},{threshold:.05});return f&&o.observe(f),()=>o.disconnect()},[m,t]),d.useEffect(()=>{if(c){const f=setTimeout(()=>g(!1),500);return()=>clearTimeout(f)}},[c]),d.useEffect(()=>{(()=>{if(!i.current)return;const o=document.querySelector(".currentSlide");if(!o)return;const h=o.getBoundingClientRect(),x=i.current.getBoundingClientRect(),j=h.left+h.width/2-(x.left+x.width/2);i.current.scrollLeft+=j})()},[t,r,c]),{containerRef:i,isChangingSlide:c,changeStory:f=>{const o=n[t],h=f==="next";if(f==="close"){l(null),a(0);return}else{let x=s+(h?1:-1);const j=t+(h?1:-1);(x<0||x>=o.slides.length)&&(l(j>=0&&j<n.length?j:null),x=0),a(x)}},handleTouch:(f,o)=>{if(o==="start")b(null),i.current.dataset.touchStart=f.touches[0].clientX;else if(o==="move"){const h=f.touches[0].clientX-i.current.dataset.touchStart;b(h>20?"prev":"next")}},getPaginatedLists:()=>u!=null&&u.id?n:n.filter((f,o)=>o===t-1||o===t||o===t+1),currentSlideIndex:s}},D=d.createContext();function xe({currentListIndex:t,setList:l,storiesList:n}){const{containerRef:s,isChangingSlide:a,changeStory:i,handleTouch:r,getPaginatedLists:m,currentSlideIndex:b}=re(t,l,n);return e.jsx("div",{ref:s,className:`${a?"overflow-hidden":"overflow-auto"} fixed bg-gray-950/80 hidden-scroll-bar inset-0 z-50 lg:flex items-center justify-center snap-x snap-mandatory lg:snap-none`,children:e.jsxs("div",{onTouchMove:c=>r(c,"move"),onTouchStart:c=>r(c,"start"),className:"inline-flex items-center lg:gap-x-8 size-full lg:px-[500vw]",children:[m().map(({slides:c},g)=>{if(c)return e.jsx("div",{className:`${g===t?"lg:h-[95vh] currentSlide":"lg:h-[80vh]"} flex-none h-full select-none w-full lg:relative lg:w-96 transition-all duration-500 z-40 snap-end`,children:c.map((u,v)=>{var p;return t===g?b===v&&e.jsx(D.Provider,{value:{changeStoryHandler:i,listIndex:g,currentListIndex:t,list:c,currentSlideIndex:b,slideindex:v,story:u},children:e.jsx(ie,{},v)}):e.jsx("div",{className:"size-full first-of-type:flex hidden relative bg-gray-950 lg:rounded-xl items-center",children:e.jsxs("div",{onClick:()=>l(g),className:"size-full select-none flex flex-col gap-y-2 items-center justify-center",children:[e.jsx("div",{className:"size-28 bg-gray-50/20 overflow-hidden rounded-full",children:u!=null&&u.authorProfilePic?e.jsx("img",{src:u==null?void 0:u.authorProfilePic,className:"object-cover"}):e.jsx(R,{className:"text-4xl mt-2 text-gray-50"})}),e.jsx("h4",{className:"text-gray-50",children:(p=u.author)==null?void 0:p.first_name})]})},v)})},g)}),e.jsx("div",{className:`${a?"opacity-100 visible":"invisible opacity-0"} fixed inset-0 z-50 transition-all`}),e.jsx("div",{onClick:()=>l(null),id:"list-background",className:"fixed inset-0 bg-gray-950/80 hidden lg:block"})]})})}const S=()=>d.useContext(D);export{xe as S};
