import{bz as B,bA as O,bB as M,bC as A,r as u,b as R,j as e,aK as T,bD as _,m as F,K as H,bE as U,bF as X,bG as V,bH as q,bd as G,be as I,bI as K,_ as N,aH as k,aM as E,l as W,ad as Q,ae as J}from"./index-DjBRLo1V.js";import{g as C,r as w,u as P,e as Y}from"./index.esm2017-CV0xs99B.js";import{a as Z}from"./index-VAnfA4mJ.js";import{b as L}from"./index-BlTZZL_3.js";function ee(t){t.values.forEach(a=>a.stop())}function te(){const t=new Set,a={subscribe(s){return t.add(s),()=>void t.delete(s)},start(s,r){const n=[];return t.forEach(i=>{n.push(B(i,s,{transitionOverride:r}))}),Promise.all(n)},set(s){return t.forEach(r=>{O(r,s)})},stop(){t.forEach(s=>{ee(s)})},mount(){return()=>{a.stop()}}};return a}function se(){const t=M(te);return A(t.mount,[]),t}const ae=se;function ne(t,a){const[s,r]=u.useState(t),[n,i]=u.useState(!0),c=u.useRef(),d=u.useRef();return u.useEffect(()=>{if(!n)return d.current=Date.now(),c.current=setTimeout(()=>{a()},s),()=>clearTimeout(c.current)},[s,n,a]),{remainingTime:s,pause:n,handlePause:l=>{i(h=>l||!h)},setRemainingTime:r,setPause:i}}function le({setRemainingTime:t,loading:a,changeStoryHandler:s,pause:r,handlePause:n,contextMenuShow:i}){var f;const{story:c,slideindex:d,currentSlideIndex:g}=S(),l=u.useRef(),[h,x]=u.useState(!1),{auth_status:v,userId:b}=R(o=>o.userData);function j(){var z;x(!0),n();const o=C(),m=w(o,`stories/${c.id}`),p=v===401?_():b,y=(z=c==null?void 0:c.seenBy)==null?void 0:z.filter(D=>D!==p);P(m,{seenBy:[...y||[],p]})}return u.useEffect(()=>{l.current&&(r?l.current.pause():l.current.play())},[r]),e.jsxs("div",{className:"size-full relative z-40 overflow-hidden flex items-center justify-center p-6",children:[!h&&e.jsx(T,{className:"size-20 lg:size-36 absolute"}),(f=c.type)!=null&&f.startsWith("image/")?e.jsx("img",{src:c.contentUrl,alt:"story-content",className:"size-full object-contain",onLoad:()=>j()}):e.jsx("video",{ref:l,onLoadedData:()=>j(),onPlaying:o=>{const m=Math.max(0,(o.target.duration-o.target.currentTime)*1e3);t(m)},autoPlay:g===d,className:"size-full object-cover",src:c.contentUrl}),a&&e.jsxs("div",{className:"absolute z-50 inset-0 flex flex-col text-gray-200 gap-y-4 font-medium bg-gray-900/80 rounded-xl items-center justify-center",children:[e.jsx(T,{className:"size-24"}),e.jsx("p",{children:"Deleting story, please dont refresh page"})]}),e.jsxs("div",{onTouchStart:()=>n(!0),onTouchEnd:()=>n(!1),className:"absolute z-50 inset-0 flex",children:[e.jsx("div",{onClick:()=>!i&&!a&&s("prev"),className:"h-full w-2/5"}),e.jsx("div",{onClick:()=>!i&&!a&&s("next"),className:"h-full w-3/5"})]})]})}function re({remainingTime:t,pause:a}){const s=ae(),{list:r,currentSlideIndex:n}=S();return u.useEffect(()=>{a?s.stop():s.start({translateX:"0%",transition:{duration:t/1e3,ease:"linear"}})},[a,t]),e.jsx("div",{className:"flex gap-2 p-2",children:r.map((i,c)=>e.jsx("p",{className:`${c===n?"bg-gray-50":"bg-gray-400"} w-full h-1 rounded-xl overflow-hidden relative`,children:c===n&&e.jsx(F.div,{className:"bg-primary-300 h-1 absolute left-0 top-0 w-full",initial:{translateX:"-100%"},animate:s,transition:{duration:t/1e3,ease:"linear"}})},c))})}function ie({pause:t,handlePause:a,setLoading:s,loading:r,contextMenuShow:n,setContextMenu:i}){const{changeStoryHandler:c,story:d}=S(),g=u.useRef();H(g,h,!n);const{userId:l}=R(b=>b.userData);function h(){a(),i(!1)}async function x(){try{s(!0),a(!1);const b=G(I,d.contentUrl);await K(b);const j=C(),f=w(j,`stories/${d.id}`);await Y(f),N.success("story removed successfully")}catch(b){N.remove(),N.error("There was an error on delete story, please try again later"),s(!1),a(!1),console.log(b)}}async function v(){try{s(!0),a(!1);const b=C(),j=w(b,`stories/${d.id}`);P(j,{highlightRef:null,title:null}),N.success("highlight removed successfully"),s(!1),a(!0)}catch(b){N.error("There was an error on remove highlight, please try again later"),s(!1),a(!1),console.log(b)}}return e.jsxs("div",{ref:g,className:"flex items-center gap-x-2 relative",children:[e.jsx("button",{onClick:()=>a(),className:"text-gray-50",children:t?e.jsx(U,{className:"text-xl"}):e.jsx(Z,{className:"text-2xl"})}),e.jsx("button",{onClick:()=>{a(!0),i(!0)},className:"text-3xl text-gray-50",children:e.jsx(X,{className:"rotate-90"})}),e.jsxs("div",{className:`${n?"opacity-100 visible":"opacity-0 invisible"} ${r&&"hidden"} text-base flex top-8 p-1 flex-col bg-gray-50 text-gray-950 absolute right-0 rounded-lg overflow-hidden`,children:[e.jsxs("button",{onClick:()=>{v(),i(!1)},disabled:!(d!=null&&d.highlightRef)||d.authorId!==l,className:"flex disabled:hidden hover:bg-gray-800 rounded-md hover:text-gray-50 transition-all items-center gap-x-2 text-center text-nowrap px-4 py-2",children:[e.jsx(L,{className:"text-xl"}),e.jsx("p",{children:"Remove highlight"})]}),e.jsxs("button",{disabled:d.authorId!==l,onClick:()=>{x(),i(!1)},className:"flex disabled:hidden hover:bg-gray-800 rounded-md hover:text-gray-50 transition-all items-center gap-x-2 text-center text-nowrap px-4 py-2",children:[e.jsx("p",{children:e.jsx(V,{})}),e.jsx("p",{children:"Delete story"})]}),e.jsxs("button",{onClick:()=>{c("close")},className:"flex disabled:hidden hover:bg-gray-800 rounded-md hover:text-gray-50 transition-all text-red-500 items-center gap-x-2 text-center text-nowrap px-4 py-2",children:[e.jsx(q,{className:"rotate-45 text-xl"}),e.jsx("p",{children:"Close"})]})]})]})}function oe(){const{changeStoryHandler:t,listIndex:a,currentListIndex:s,story:r}=S(),[n,i]=u.useState(!1),{remainingTime:c,pause:d,handlePause:g,setRemainingTime:l}=ne(5e3,()=>t("next")),[h,x]=u.useState(!1);return e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"size-full relative z-50 bg-gray-950 lg:rounded-xl flex items-center",children:[e.jsx("div",{className:"z-50 absolute -left-4 h-1/2 hidden xl:flex items-center",children:e.jsx("button",{disabled:n,onClick:()=>t("prev"),className:"text-2xl disabled:hidden rounded-full p-1.5 hover:bg-opacity-100 bg-gray-50 bg-opacity-50 transition-all top-1/2 rotate-180",children:e.jsx(k,{})})}),e.jsxs("div",{className:`${a===s?"block":"hidden"} absolute z-50 top-0 w-full p-1`,children:[e.jsx(re,{pause:d,remainingTime:c}),e.jsxs("div",{className:"w-full flex items-center justify-between px-2",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"size-10 bg-gray-50/20 rounded-full overflow-hidden flex items-center justify-center",children:r!=null&&r.authorProfilePic?e.jsx("img",{src:r==null?void 0:r.authorProfilePic,className:"object-cover"}):e.jsx(E,{className:"text-4xl mt-2 text-gray-50"})}),e.jsx("h6",{className:"text-gray-50 text-lg",children:r.author.first_name})]}),e.jsx(ie,{pause:d,handlePause:g,setLoading:i,loading:n,contextMenuShow:h,setContextMenu:x})]})]}),e.jsx(le,{setRemainingTime:l,loading:n,changeStoryHandler:t,handlePause:g,pause:d,contextMenuShow:h}),e.jsx("div",{className:`${a!==s&&"!hidden"} absolute -right-4 h-1/2 hidden xl:flex items-center`,children:e.jsx("button",{disabled:n,onClick:()=>t("next"),className:"text-2xl disabled:hidden disabled:bg-gray-500 disabled:opacity-50 rounded-full p-1.5 z-50 hover:bg-opacity-100 bg-gray-50 bg-opacity-50 transition-all top-1/2",children:e.jsx(k,{})})})]}),n&&e.jsx("div",{className:"fixed inset-0 z-40"})]})}const ce=(t,a,s)=>{const[r,n]=u.useState(0),i=u.useRef(),c=W({maxWidth:768}),[d,g]=u.useState(null),[l,h]=u.useState(!1);Q(780,!1);const x=J();return u.useEffect(()=>{var o,m;const f=(m=(o=s[t])==null?void 0:o.slides)==null?void 0:m.findIndex(({isSeen:p})=>!p);n(f>=0?f:0)},[t]),u.useEffect(()=>{const f=document.querySelector(".currentSlide"),o=new IntersectionObserver(([m])=>{if(!m.isIntersecting&&d!==null){const p=d==="next"?t<s.length-1?t+1:null:t-1;h(!0),a(p),n(0),g(null)}},{threshold:.05});return f&&o.observe(f),()=>o.disconnect()},[d,t]),u.useEffect(()=>{if(l){const f=setTimeout(()=>h(!1),500);return()=>clearTimeout(f)}},[l]),u.useEffect(()=>{(()=>{if(!i.current)return;const o=document.querySelector(".currentSlide");if(!o)return;const m=o.getBoundingClientRect(),p=i.current.getBoundingClientRect(),y=m.left+m.width/2-(p.left+p.width/2);i.current.scrollLeft+=y})()},[t,c,l]),{containerRef:i,isChangingSlide:l,changeStory:f=>{const o=s[t],m=f==="next";if(f==="close"){a(null),n(0);return}else{let p=r+(m?1:-1);const y=t+(m?1:-1);(p<0||p>=o.length)&&(a(y>=0&&y<s.length?y:null),p=0),n(p)}},handleTouch:(f,o)=>{if(o==="start")g(null),i.current.dataset.touchStart=f.touches[0].clientX;else if(o==="move"){const m=f.touches[0].clientX-i.current.dataset.touchStart;g(m>20?"prev":"next")}},getPaginatedLists:()=>x!=null&&x.id?s:s.filter((f,o)=>o===t-1||o===t||o===t+1),currentSlideIndex:r}},$=u.createContext();function he({currentListIndex:t,setList:a,storiesList:s}){const{containerRef:r,isChangingSlide:n,changeStory:i,handleTouch:c,getPaginatedLists:d,currentSlideIndex:g}=ce(t,a,s);return R(l=>l.userData),e.jsx("div",{ref:r,className:`${n?"overflow-hidden":"overflow-auto"} fixed bg-gray-950/80 hidden-scroll-bar inset-0 z-50 lg:flex items-center justify-center snap-x snap-mandatory lg:snap-none`,children:e.jsxs("div",{onTouchMove:l=>c(l,"move"),onTouchStart:l=>c(l,"start"),className:"inline-flex items-center lg:gap-x-8 size-full lg:px-[500vw]",children:[d().map(({slides:l},h)=>{if(l)return e.jsx("div",{className:`${h===t?"lg:h-[95vh] currentSlide":"lg:h-[80vh]"} flex-none h-full select-none w-full lg:relative lg:w-96 transition-all z-40 snap-end`,children:l.map((x,v)=>{var b;return t===h?g===v&&e.jsx($.Provider,{value:{changeStoryHandler:i,listIndex:h,currentListIndex:t,list:l,currentSlideIndex:g,slideindex:v,story:x},children:e.jsx(oe,{},v)}):e.jsx("div",{className:"size-full first-of-type:flex hidden relative bg-gray-950 lg:rounded-xl items-center",children:e.jsxs("div",{onClick:()=>a(h),className:"size-full select-none flex flex-col gap-y-2 items-center justify-center",children:[e.jsx("div",{className:"size-28 bg-gray-50/20 overflow-hidden rounded-full",children:x!=null&&x.authorProfilePic?e.jsx("img",{src:x==null?void 0:x.authorProfilePic,className:"object-cover"}):e.jsx(E,{className:"text-4xl mt-2 text-gray-50"})}),e.jsx("h4",{className:"text-gray-50",children:(b=x.author)==null?void 0:b.first_name})]})},v)})},h)}),e.jsx("div",{className:`${n?"opacity-100 visible":"invisible opacity-0"} fixed inset-0 z-50 transition-all`}),e.jsx("div",{onClick:()=>a(null),id:"list-background",className:"fixed inset-0 bg-gray-950/80 hidden lg:block"})]})})}const S=()=>u.useContext($);export{he as S};
